<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel='stylesheet' href='welcome.css' type='text/css' />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="Electronic Score Card for a beta clue game with RC tanks...">
        <meta name="msvalidate.01" content="0B5D718961F147D87584052452B21483" />
        <title>Score Card!</title>
        <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="310x310" href="/ms-icon-310x310.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png">
        <link rel="icon" type="image/png" sizes="1000x1000" href="/favicon-1000x1000.png">
        <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <meta name="msapplication-TileColor" content="#7000FF">
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
        <meta name="theme-color" content="#7000FF">
        <link rel="manifest" href="/manifest.json">
    </head>
    <body>
        <script>
            var confirming = false;
            var globreg = 0;
            console.log("Running... (install.js)");

            function checkVersion(reg) {
                if (globreg == 0) return;
                console.log("checkVersion started... (install.js)");

                function listenForWaitingServiceWorker(reg, callback) {
                    function awaitStateChange() {
                        console.log("Awaiting state change.");
                        reg.installing.addEventListener('statechange', function() {
                            if (this.state === 'installed') {
                                console.log("Prompting user to refresh.");
                                callback(reg);
                            }
                        });
                    }
                    if (!reg) {
                        console.log("Error: Reg isn't working (install.js)");
                        return;
                    }
                    if (reg.waiting) {
                        console.log("Prompting user to refresh. (install.js)");
                        return callback(reg);
                    }
                    if (reg.installing) {
                        awaitStateChange();
                    }
                    reg.addEventListener('updatefound', awaitStateChange);
                }
                var refreshing;
                navigator.serviceWorker.addEventListener('controllerchange',
                    function() {
                        if (refreshing) return;
                        refreshing = true;

                        window.location.reload();
                    }
                );

                function promptUserToRefresh(reg) {
                    console.log("I think it's time to update. (install.js)");
                    if (!confirming) {
                        confirming = true;
                        console.log("Confirming...");
                        if (window.confirm("Refresh all tabs now and get the latest version of the ClueCard?")) {
                            reg.waiting.postMessage('skipWaiting');
                        }
                        confirming = false;
                    }
                }
                listenForWaitingServiceWorker(reg, promptUserToRefresh);
            }
            setInterval(5000, checkVersion, globreg);
            window.addEventListener("load", function() {
                if ("serviceWorker" in navigator) {
                    console.log("Trying to install service worker... (install.js)");
                    navigator.serviceWorker
                        .register("/sw.js")
                        .then(function(reg) {
                            globreg = reg;
                            console.log("Service worker: installed! (install.js)", reg);
                        }).catch (err => console.log("Service worker: not registered (install.js)", err));
                }
                setTimeout(2000, checkVersion, globreg);
                let deferredPrompt;
                const addBtn = document.getElementById("add2hs");
                const addAlt = document.getElementById("add2hsalt");
                addBtn.style.display = 'none';
                addAlt.style.display = 'none';
                window.addEventListener('beforeinstallprompt', (e) => {
                    // Prevent Chrome 67 and earlier from automatically showing the prompt
                    e.preventDefault();
                    // Stash the event so it can be triggered later.
                    deferredPrompt = e;
                    // Update UI to notify the user they can add to home screen
                    addBtn.style.display = 'block';
                    addAlt.style.display = 'block';
                    addBtn.addEventListener('click', (e) => {
                        // hide our user interface that shows our A2HS button
                        addBtn.style.display = 'none';
                        addAlt.style.display = 'none';
                        // Show the prompt
                        deferredPrompt.prompt();
                        // Wait for the user to respond to the prompt
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted the A2HS prompt (install.js)');
                            } else {
                                console.log('User dismissed the A2HS prompt (install.js)');
                            }
                            deferredPrompt = null;
                        });
                    });
                });
            });
        </script>
        <noscript>Hey, this site won't make any sense if you turn JavaScript off. Can you turn it on again or use a different browser with JavaScript on? Thanks.</noscript>
        <h1>Welcome...</h1>
        <h3>You've accepted the invitation. Now it's time to start going.</h3>
        <button id="start">Let's do this.</button><br/>
        <button id="add2hs">Add E-Scorecard to Home Screen</button>
        <div id="add2hsalt">
        It's completely fine to add the E-Scorecard because:
            <ul>
                <li>It's tiny! It doesn't really take up any space on your phone or computer.</li>
                <li>It's just as safe to add E-Scorecard to your home screen as visiting E-Scorecard in your web browser.</li>
            </ul>
        </div>
    </body>
</html>
